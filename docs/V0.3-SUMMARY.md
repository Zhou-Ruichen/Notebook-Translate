# V0.3.0 技术文档：架构升级与安全增强

v0.3.0 是一个重要的里程碑版本，重点解决了 **安全性**、**灵活性** 和 **用户体验** 三大痛点。本版本引入了多配置 Profile 系统、密钥安全存储 (SecretStorage)、状态栏交互以及对推理模型的深度支持。

## 🏗 核心架构变更

### 1. 配置管理重构 (ProfileManager)

v0.3.0 废弃了扁平化的配置结构（如 `ipynbTranslator.openai.apiKey`），采用了 **Profile（配置档案）** 系统。

- **分离存储原则**：
  - **Settings (`settings.json`)**: 仅存储公开的配置元数据（如 `name`, `model`, `baseUrl`, `customPrompt`）。
  - **Secrets (`Keychain`)**: 敏感凭据（如 API Key, Secret Key）通过 VSCode `SecretStorage` API 存储在系统钥匙串中，绝不写入配置文件。

- **类设计 (`src/profileManager.ts`)**:
  - `getProfiles()`: 读取所有配置元数据。
  - `getApiKey(name)`: 异步从安全存储中获取密钥。
  - `migrateLegacyKeys()`: 启动时自动扫描旧版配置，提取密钥存入 Keychain，并清理旧配置。

### 2. 状态栏与交互 (UI/UX)

- **`src/statusBar.ts`**:
  - 引入 `TranslatorStatusBar` 类，实时显示当前 Profile 名称及状态。
  - 状态流转：`$(globe) Ready` -> `$(sync~spin) Testing` -> `$(check) Success / $(alert) Error`。
  - **静默测试**: 切换配置时自动在后台测试连通性，仅通过图标反馈，不再弹出侵入式通知。

### 3. 推理模型支持 (DeepSeek R1)

- **`src/translator.ts`**:
  - 新增 `cleanThinkTags` 函数。
  - 针对 DeepSeek R1 等推理模型，自动清洗 ` <think>...</think>` 思维链内容。
  - **安全机制**: 如果清洗后内容为空（模型仅输出思考过程），抛出 `Translation Empty (Reasoning only)` 错误，防止覆盖用户原文。

## 📂 文件清单与职责

v0.3.0 新增及核心修改的文件：

| 文件 | 职责 |
|------|------|
| `src/profileManager.ts` | **核心**。管理 Profile 增删改查、密钥安全读写、旧配置迁移。 |
| `src/statusBar.ts` | **UI**。管理状态栏图标、点击事件、状态更新逻辑。 |
| `src/statistics.ts` | **数据**。负责翻译统计数据的收集与持久化（`.vscode/translator-stats.jsonl`）。 |
| `src/migration.ts` | **兼容性**。处理 v0.1/v0.2 到 v0.3 的一次性配置迁移。 |
| `src/types.ts` | **类型定义**。定义 `TranslatorProfile` 联合类型及 `TranslationProvider` 枚举。 |
| `src/extension.ts` | **入口**。集成所有服务，注册规范化命令 (`IPynb Translator: ...`)。 |

## 🔄 迁移逻辑

当用户从 v0.2 升级到 v0.3 时，`migration.ts` 会执行以下操作：

1. **检测旧配置**: 检查 `ipynbTranslator.openai.apiKey` 是否存在。
2. **创建 Profile**: 自动创建一个名为 `"Migrated OpenAI"` 的 Profile。
3. **转移密钥**: 将旧 Key 存入 SecretStorage。
4. **清理现场**: 删除 `settings.json` 中的旧字段，确保无残留。

## 📊 统计系统

新增统计日志功能，默认记录在工作区根目录 `.vscode/translator-stats.jsonl`。

**日志格式**:
```json
{"timestamp":"2023-10-27T10:00:00.123Z","model":"gpt-4o","profileName":"My GPT4","charCount":150,"durationMs":850}
```

用于帮助用户分析 Token 消耗和模型响应延迟。可在设置中关闭 (`ipynbTranslator.enableStatsLogging`)。

---

## 🔧 V0.3.1 补丁更新

v0.3.1 是针对 v0.3.0 的紧急修复版本，解决了关键的交互问题：

### 🐛 Bug Fixes

| 问题 | 修复 |
|------|------|
| 状态栏点击报错 `command 'ipynbTranslator.selectProfile' not found` | 重新注册 `selectProfile` 命令，重定向至 `manageProfiles` |
| 删除配置残留 (Zombie Profiles) | 启动时验证 `activeProfile` 是否有效，无效则自动重置 |
| 缺少 Key 时弹窗死循环 | 新增 `MissingApiKeyError`，改为显示 "Manage Profiles" 按钮 |

### ✨ UX 改进

- **统一管理入口**: 新增 `src/commands/manageProfiles.ts`，将 Switch/Add/Delete 合并为一站式菜单
- **自动回滚**: 切换配置失败时自动回退到上一个可用配置，无需用户手动操作
- **原子删除**: `deleteProfile()` 现在同时清除 `settings.json` 条目和 `SecretStorage` 密钥

### 📂 新增文件

| 文件 | 职责 |
|------|------|
| `src/commands/manageProfiles.ts` | 统一的 Profile 管理命令逻辑（Switch / Add / Delete 向导） |
